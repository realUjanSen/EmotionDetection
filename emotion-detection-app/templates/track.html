<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Tracking Session | Dr. Victor Blane's Therapy Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #6c757d;
            --accent-color: #28a745;
            --light-bg: #f8f9fa;
            --text-dark: #333;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, rgba(44, 90, 160, 0.05), rgba(108, 117, 125, 0.02)), 
                        url('https://images.unsplash.com/photo-1576091160550-2173dba999ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            color: var(--text-dark);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .navbar {
            background: rgba(44, 90, 160, 0.95) !important;
            backdrop-filter: blur(10px);
            font-size: 0.875rem;
            padding: 0.5rem 0;
        }
        
        .navbar-brand {
            font-size: 1.1rem;
            font-weight: 700;
            white-space: nowrap;
        }
        
        /* LinkedIn-style vertical nav items */
        .navbar-nav {
            display: flex;
            gap: 0.5rem;
        }
        
        .nav-item {
            display: flex;
        }
        
        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0.75rem !important;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 8px;
            min-width: 70px;
        }
        
        .nav-link i {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            margin-right: 0 !important;
        }
        
        .nav-link span {
            font-size: 0.75rem;
            text-align: center;
            line-height: 1.2;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            color: white !important;
            transform: translateY(-1px);
        }
        
        .nav-link.logout-btn {
            background: var(--primary-color);
            border: 2px solid white;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .nav-link.logout-btn:hover {
            background: rgba(255, 255, 255, 0.2) !important;
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.15) !important;
        }
        
        .session-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .webcam-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .video-frame {
            border-radius: 15px;
            border: 3px solid var(--primary-color);
            box-shadow: 0 10px 25px rgba(44, 90, 160, 0.2);
        }
        
        .emotion-display {
            background: linear-gradient(135deg, var(--primary-color), #4a90e2);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(44, 90, 160, 0.3);
        }
        
        /* Custom style for capture emotion button to match detected emotion card */
        .btn-capture-emotion {
            background: linear-gradient(135deg, var(--primary-color), #4a90e2) !important;
            color: white !important;
            border-radius: 15px !important;
            font-weight: 600;
            padding: 1.5rem !important;
            font-size: 1.2rem;
            box-shadow: 0 10px 25px rgba(44, 90, 160, 0.3) !important;
            border: none !important;
            transition: all 0.3s ease !important;
            text-align: center;
            width: 100%;
            max-width: 300px;
        }
        
        .btn-capture-emotion:hover, 
        .btn-capture-emotion:focus {
            background: linear-gradient(135deg, #1e3c72, #2a5298) !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 12px 30px rgba(44, 90, 160, 0.4) !important;
        }
        
        .debug-panel {
            background: rgba(33, 37, 41, 0.9);
            color: #00ff41;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .btn-custom {
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-start {
            background: var(--accent-color);
            border: none;
            color: white;
        }
        
        .btn-start:hover {
            background: #1e7e34;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-stop {
            background: #dc3545;
            border: none;
            color: white;
        }
        
        .btn-stop:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 10px;
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        /* Custom navbar button hover effect */
        .navbar .nav-link[href*="register"]:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.8) !important;
            color: white !important;
        }

        #processed-frame-canvas {
            width: 400px;
            height: 300px;
        }
        #webcam.video-frame {
            width: 400px !important;
            height: 300px !important;
            max-width: 100%;
            max-height: 100%;
        }

        /* Demo alert style */
        #demo-alert {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 2000;
            border-radius: 0;
        }

        /* Footer Styles */
        #lowerbar {
            background-color: #1a1a1a;
            padding: 40px 0 20px 0;
            border-top: 1px solid #333;
            margin-top: 3rem;
        }

        #lowerbar .container {
            max-width: 1200px;
        }

        #lowerbar ul.upper {
            list-style: none;
            padding: 0;
            margin: 0 0 30px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        #lowerbar ul.upper li {
            font-size: 14px;
        }

        #lowerbar ul.upper li a {
            color: white !important;
            text-decoration: none !important;
            transition: color 0.3s ease;
        }

        #lowerbar ul.upper li a:hover {
            color: #2c5aa0 !important;
        }

        #lowerbar ul.lower {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        #lowerbar ul.lower li {
            font-size: 13px;
        }

        #lowerbar ul.lower li a {
            color: #b0b0b0 !important;
            text-decoration: none !important;
            transition: color 0.3s ease;
        }

        #lowerbar ul.lower li a:hover {
            color: #2c5aa0 !important;
        }

        .social-icons {
            list-style: none;
            padding: 0;
            margin: 20px 0;
            display: flex !important;
            gap: 15px;
            justify-content: center;
        }

        .social-icons li a {
            font-size: 18px;
            color: white !important;
            transition: color 0.3s ease;
            text-decoration: none;
        }

        .social-icons li a:hover {
            color: #2c5aa0 !important;
        }

        #language-selector-btn-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        #language-selector-btn-container i {
            color: white;
        }

        #language-selector-btn {
            font-size: 14px;
            color: white !important;
            text-decoration: none !important;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        #language-selector-btn:hover {
            color: #2c5aa0 !important;
            text-decoration: underline;
        }

        #lowerbar .copyright {
            text-align: center;
            margin-top: 30px;
            color: white;
            border-top: 1px solid #333;
            padding-top: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm mb-4" style="background: rgba(44, 90, 160, 0.95) !important; backdrop-filter: blur(10px);">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">
                <i class="fas fa-brain me-1"></i>Dr. Victor Blane's Center
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {% if session.get('logged_in') %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('track') }}">
                            <i class="fas fa-video"></i>
                            <span>Track</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('trends') }}">
                            <i class="fas fa-chart-line"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link logout-btn" href="{{ url_for('logout') }}">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-home"></i>
                            <span>Home</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}#services">
                            <i class="fas fa-concierge-bell"></i>
                            <span>Services</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}#carousel">
                            <i class="fas fa-images"></i>
                            <span>Gallery</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}#testimonials">
                            <i class="fas fa-comments"></i>
                            <span>Reviews</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link logout-btn" href="{{ url_for('login') }}">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Login</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link ms-2 px-3" href="{{ url_for('register') }}" style="background: var(--primary-color); border: 2px solid white; border-radius: 8px; transition: all 0.3s ease;">
                            <i class="fas fa-user-plus me-1"></i>Get Started
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    {% if not session.get('logged_in') %}
    <div id="demo-alert" class="alert alert-warning text-center mb-0" style="position: fixed; bottom: 0; left: 0; width: 100%; z-index: 2000; border-radius: 0;">
        <strong>Demo Mode:</strong> You have <span id="demo-countdown">60</span> seconds to try the live emotion tracking. Please log in or register for unlimited access.
    </div>
    <script>
        let demoSeconds = 60;
        const demoCountdown = document.getElementById('demo-countdown');
        const demoInterval = setInterval(() => {
            demoSeconds--;
            if (demoCountdown) demoCountdown.textContent = demoSeconds;
            if (demoSeconds <= 0) {
                clearInterval(demoInterval);
                window.location.href = '/';
            }
        }, 1000);
    </script>
    {% endif %}
    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="session-card p-4 mb-4">
                    <div class="text-center mb-4">
                        <h1 class="section-title mb-3">
                            <i class="fas fa-video me-2"></i>Live Emotion Tracking Session
                        </h1>
                        <p class="text-muted">Advanced AI-powered emotion detection to understand your feelings in real-time</p>
                    </div>

                    <!-- Camera Controls -->
                    <div class="text-center mb-4">
                        <button id="startCameraBtn" class="btn btn-start btn-custom me-3">
                            <i class="fas fa-play me-2"></i>Start Session
                        </button>
                        <button id="stopCameraBtn" class="btn btn-stop btn-custom" disabled>
                            <i class="fas fa-stop me-2"></i>End Session
                        </button>
                    </div>

                    <!-- Video Stream Area -->
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="webcam-container text-center">
                                <h5 class="mb-3">Live Camera Feed</h5>
                                <div id="camera-placeholder" class="text-muted">
                                    <i class="fas fa-video fa-3x mb-3 d-block"></i>
                                    Click "Start Session" to begin emotion tracking
                                </div>
                                <video id="webcam" autoplay playsinline class="video-frame" width="400" height="300" style="display:none; margin: 0 auto;"></video>
                                <!-- Move Capture Emotion Button here -->
                                <div class="mt-3">
                                    <button id="captureEmotionBtn" class="btn btn-capture-emotion">
                                        <i class="fas fa-camera me-2"></i>Capture Emotion
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6 mb-4">
                            <div class="webcam-container text-center">
                                <h5 class="mb-3">AI Analysis</h5>
                                <div id="result-container" style="display:none;">
                                    <canvas id="processed-frame-canvas" width="400" height="300" class="video-frame mb-3"></canvas>
                                    <div class="emotion-display">
                                        <h4 class="mb-0">Detected Emotion:</h4>
                                        <div id="emotion-label" class="h2 fw-bold mt-2">--</div>
                                    </div>
                                </div>
                                <div class="text-muted" id="analysis-placeholder">
                                    <i class="fas fa-brain fa-3x mb-3 d-block"></i>
                                    AI analysis will appear here during session
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Panel -->
                    <div class="row mt-4">
                        <div class="col-lg-6">
                            <div class="stats-card p-3">
                                <h6 class="mb-3">
                                    <i class="fas fa-code me-2"></i>Session Log
                                </h6>
                                <div id="debug-info" class="debug-panel p-3">
                                    <div class="text-muted">Session not started</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="stats-card p-3">
                                <h6 class="mb-3">
                                    <i class="fas fa-database me-2"></i>Database Log
                                </h6>
                                <div id="database-log" class="debug-panel p-3">
                                    <div class="text-muted">No database activity</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Remove the old Capture Emotion Button below the session log -->
                </div>
            </div>
        </div>
        
        <!-- Emotion History Chart -->
        <div class="row">
            <div class="col-12">
                <div class="stats-card p-4 mb-4">
                    <h3 class="section-title mb-3">
                        <i class="fas fa-chart-line me-2"></i>Live Emotion Trends
                        <small class="text-muted fs-6 fw-normal ms-2">Real-time emotion tracking visualization</small>
                    </h3>
                    <div style="height: 400px; position: relative;">
                        <canvas id="emotionChart"></canvas>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-center flex-wrap gap-3">
                                <span class="badge" style="background-color: #ffc107; color: #856404;">😊 Happy</span>
                                <span class="badge" style="background-color: #36a2eb; color: #1e3a5f;">😢 Sad</span>
                                <span class="badge" style="background-color: #ff6384; color: #8b2635;">😠 Angry</span>
                                <span class="badge" style="background-color: #9966ff; color: #5a3d99;">😨 Fear</span>
                                <span class="badge" style="background-color: #ff9f40; color: #cc5500;">😲 Surprise</span>
                                <span class="badge" style="background-color: #4bc0c0; color: #2d7a7a;">🤢 Disgust</span>
                                <span class="badge" style="background-color: #c9cbcf; color: #6c757d;">😐 Neutral</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Emotion Log Table -->
        <div class="row">
            <div class="col-12">
                <div class="stats-card p-4">
                    <h3 class="section-title mb-3">
                        <i class="fas fa-history me-2"></i>Emotion History
                    </h3>
                    <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-calendar me-2"></i>Date</th>
                                    <th><i class="fas fa-smile me-2"></i>Emotion</th>
                                </tr>
                            </thead>
                            <tbody id="session-history-body">
                                {% for log in emotion_logs[-10:][::-1] %}
                                <tr>
                                    <td>{{ log.date }}</td>
                                    <td><span class="badge bg-primary">{{ log.emotion }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer id="lowerbar">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <!-- Navigation Links -->
                    <ul class="upper">
                        <li><a href="{{ url_for('index') }}">Home</a></li>
                        <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li><a href="{{ url_for('track') }}">Track Emotions</a></li>
                        <li><a href="{{ url_for('trends') }}">Analytics</a></li>
                        <li><a href="#about">About</a></li>
                        <li><a href="#contact">Contact</a></li>
                        <li><a href="#privacy">Privacy</a></li>
                        <li><a href="#terms">Terms</a></li>
                    </ul>
                    
                    <!-- Social Icons -->
                    <ul class="social-icons">
                        <li><a href="https://www.facebook.com" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a></li>
                        <li><a href="https://www.instagram.com" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a></li>
                        <li><a href="https://www.tiktok.com" target="_blank" aria-label="TikTok"><i class="fab fa-tiktok"></i></a></li>
                        <li><a href="https://twitter.com" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a></li>
                        <li><a href="https://www.linkedin.com" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a></li>
                    </ul>
                    
                    <!-- Lower Links and Language Selector -->
                    <ul class="lower">
                        <li><a href="#terms">Terms &amp; Conditions</a></li>
                        <li><a href="#privacy">Privacy Policy</a></li>
                        <li><a href="#accessibility">Web Accessibility</a></li>
                    </ul>
                    
                    <div id="language-selector-btn-container">
                        <i class="fa fa-globe"></i>
                        <button id="language-selector-btn">English</button>
                    </div>
                    
                    <!-- Copyright -->
                    <div class="copyright">
                        <p>© 2025 Victor Blane. All rights reserved. | Emotion Analysis and Therapy Center</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('emotionChart').getContext('2d');
        
        // Emotion color mapping for visual variety
        const emotionColors = {
            'happy': { bg: 'rgba(255, 193, 7, 0.3)', border: '#ffc107', color: '#856404' },
            'sad': { bg: 'rgba(54, 162, 235, 0.3)', border: '#36a2eb', color: '#1e3a5f' },
            'angry': { bg: 'rgba(255, 99, 132, 0.3)', border: '#ff6384', color: '#8b2635' },
            'fear': { bg: 'rgba(153, 102, 255, 0.3)', border: '#9966ff', color: '#5a3d99' },
            'surprise': { bg: 'rgba(255, 159, 64, 0.3)', border: '#ff9f40', color: '#cc5500' },
            'disgust': { bg: 'rgba(75, 192, 192, 0.3)', border: '#4bc0c0', color: '#2d7a7a' },
            'neutral': { bg: 'rgba(201, 203, 207, 0.3)', border: '#c9cbcf', color: '#6c757d' }
        };
        
        let emotionChartData = [];
        let maxDataPoints = 20; // Keep last 20 emotions for better visibility
        
        const emotionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Live Emotion Tracking',
                    data: [],
                    backgroundColor: 'rgba(44, 90, 160, 0.2)',
                    borderColor: '#2c5aa0',
                    borderWidth: 3,
                    pointBackgroundColor: [],
                    pointBorderColor: [],
                    pointBorderWidth: 2,
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#2c5aa0',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#2c5aa0',
                        borderWidth: 2,
                        cornerRadius: 10,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                return 'Time: ' + context[0].label;
                            },
                            label: function(context) {
                                const emotions = ['neutral', 'happy', 'sad', 'angry', 'fear', 'surprise', 'disgust'];
                                return 'Emotion: ' + emotions[context.raw] || 'Unknown';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time',
                            color: '#2c5aa0',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            color: '#666',
                            maxTicksLimit: 10
                        },
                        grid: {
                            color: 'rgba(44, 90, 160, 0.1)'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Emotion Type',
                            color: '#2c5aa0',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        min: 0,
                        max: 6,
                        ticks: {
                            stepSize: 1,
                            color: '#666',
                            callback: function(value) {
                                const emotions = ['Neutral', 'Happy', 'Sad', 'Angry', 'Fear', 'Surprise', 'Disgust'];
                                return emotions[value] || '';
                            }
                        },
                        grid: {
                            color: 'rgba(44, 90, 160, 0.1)'
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });

        function getEmotionValue(emotion) {
            const emotionMap = {
                'neutral': 0, 'happy': 1, 'sad': 2, 'angry': 3, 
                'fear': 4, 'surprise': 5, 'disgust': 6
            };
            return emotionMap[emotion.toLowerCase()] || 0;
        }
        
        function getEmotionColor(emotion) {
            return emotionColors[emotion.toLowerCase()] || emotionColors['neutral'];
        }
        
        function addEmotionToChart(emotion, timestamp) {
            const emotionValue = getEmotionValue(emotion);
            const colors = getEmotionColor(emotion);
            
            // Add new data point
            emotionChartData.push({
                emotion: emotion,
                value: emotionValue,
                timestamp: timestamp,
                colors: colors
            });
            
            // Keep only the last maxDataPoints
            if (emotionChartData.length > maxDataPoints) {
                emotionChartData.shift();
            }
            
            // Update chart data
            emotionChart.data.labels = emotionChartData.map(d => d.timestamp);
            emotionChart.data.datasets[0].data = emotionChartData.map(d => d.value);
            emotionChart.data.datasets[0].pointBackgroundColor = emotionChartData.map(d => d.colors.border);
            emotionChart.data.datasets[0].pointBorderColor = emotionChartData.map(d => d.colors.border);
            
            // Animate the update
            emotionChart.update('active');
            
            // Add a brief glow effect to the latest point
            setTimeout(() => {
                const lastIndex = emotionChart.data.datasets[0].pointRadius.length - 1;
                if (lastIndex >= 0) {
                    emotionChart.data.datasets[0].pointRadius[lastIndex] = 12;
                    emotionChart.update('none');
                    
                    setTimeout(() => {
                        emotionChart.data.datasets[0].pointRadius[lastIndex] = 8;
                        emotionChart.update('none');
                    }, 500);
                }
            }, 100);
        }

        function updateChart() {
            fetch('/api/emotion_logs')
                .then(response => response.json())
                .then(data => {
                    if (data.timestamps && data.emotions) {
                        // Clear existing data
                        emotionChartData = [];
                        
                        // Add all emotions from server
                        const recentData = data.timestamps.slice(-maxDataPoints);
                        const recentEmotions = data.emotions.slice(-maxDataPoints);
                        
                        for (let i = 0; i < recentData.length; i++) {
                            const emotion = recentEmotions[i] || 'neutral';
                            const timestamp = recentData[i];
                            
                            emotionChartData.push({
                                emotion: emotion,
                                value: getEmotionValue(emotion),
                                timestamp: timestamp,
                                colors: getEmotionColor(emotion)
                            });
                        }
                        
                        // Update chart
                        emotionChart.data.labels = emotionChartData.map(d => d.timestamp);
                        emotionChart.data.datasets[0].data = emotionChartData.map(d => d.value);
                        emotionChart.data.datasets[0].pointBackgroundColor = emotionChartData.map(d => d.colors.border);
                        emotionChart.data.datasets[0].pointBorderColor = emotionChartData.map(d => d.colors.border);
                        emotionChart.update();
                    }
                })
                .catch(err => {
                    console.error('Error updating chart:', err);
                });
        }

        // Webcam integration and frame sending
        const video = document.getElementById('webcam');
        const processedFrame = document.getElementById('processed-frame-canvas');
        const resultContainer = document.getElementById('result-container');
        const emotionLabel = document.getElementById('emotion-label');
        const debugInfo = document.getElementById('debug-info');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const analysisPlaceholder = document.getElementById('analysis-placeholder');
        let debugLogs = [];
        const MAX_LOGS = 100; // Increased from 10 to 100

        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push(`[${timestamp}] ${message}`);
            if (debugLogs.length > MAX_LOGS) {
                debugLogs.shift(); // Remove oldest log
            }
            debugInfo.innerHTML = debugLogs.map(log => `<div>${log}</div>`).join('');
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        const databaseLog = document.getElementById('database-log');

        function addDatabaseLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            databaseLog.appendChild(logEntry);
            databaseLog.scrollTop = databaseLog.scrollHeight;
        }

        let streaming = false;
        function sendFrameToServer() {
            if (!streaming) return;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(function(blob) {
                const formData = new FormData();
                formData.append('frame', blob, 'frame.jpg');
                addDebugLog('Sending frame to server...');
                fetch('/process_frame', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    addDebugLog('Received response from server.');
                    return response.json();
                })
                .then(data => {
                    const ctxProcessed = processedFrame.getContext('2d');
                    let img = new window.Image();
                    img.onload = function() {
                        ctxProcessed.clearRect(0, 0, processedFrame.width, processedFrame.height);
                        ctxProcessed.drawImage(img, 0, 0, processedFrame.width, processedFrame.height);
                    };
                    img.src = 'data:image/jpeg;base64,' + data.image;
                    emotionLabel.textContent = data.emotion;
                    resultContainer.style.display = 'block';
                    analysisPlaceholder.style.display = 'none';
                    addDebugLog('Emotion: ' + data.emotion + '\nFrame processed and displayed.' + (data.debug ? ('\n' + data.debug) : ''));

                    // --- Live chart and session history update ---
                    const now = new Date();
                    const timestamp = now.toLocaleTimeString();
                    addEmotionToChart(data.emotion, timestamp);
                    // Add to session history table (if emotion is not '--')
                    if (data.emotion && data.emotion !== '--') {
                        const tableBody = document.getElementById('session-history-body');
                        const newRow = document.createElement('tr');
                        const dateCell = document.createElement('td');
                        const emotionCell = document.createElement('td');
                        dateCell.textContent = now.toLocaleString();
                        emotionCell.innerHTML = `<span class="badge bg-primary">${data.emotion}</span>`;
                        newRow.appendChild(dateCell);
                        newRow.appendChild(emotionCell);
                        tableBody.insertBefore(newRow, tableBody.firstChild);
                        while (tableBody.children.length > 10) {
                            tableBody.removeChild(tableBody.lastChild);
                        }
                    }
                    // --- End live update ---
                })
                .catch(err => {
                    errorDiv.textContent = 'Error processing frame: ' + err.message;
                    errorDiv.classList.remove('d-none');
                    addDebugLog('Error: ' + err.message);
                });
            }, 'image/jpeg');
        }
        let stream = null;
        let sendingFrame = false;
        let latestFrameTimeout = null;
        document.getElementById('startCameraBtn').onclick = async function() {
            try {
                addDebugLog('Attempting to access the camera...');
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                if (!stream) {
                    throw new Error('No video stream available.');
                }
                video.srcObject = stream;
                video.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
                analysisPlaceholder.style.display = 'block';
                streaming = true;
                addDebugLog('Camera started successfully. Streaming enabled.');
                this.disabled = true;
                document.getElementById('stopCameraBtn').disabled = false;
                // Start sending frames to server
                requestAnimationFrame(scheduleFrameSend);
            } catch (err) {
                alert('Error accessing the camera: ' + err.message);
                addDebugLog('Error accessing the camera: ' + err.message);
            }
        };
        document.getElementById('stopCameraBtn').onclick = function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
                cameraPlaceholder.style.display = 'block';
                analysisPlaceholder.style.display = 'block';
                resultContainer.style.display = 'none';
                streaming = false;
                addDebugLog('Camera stopped. Streaming disabled.');
                this.disabled = true;
                document.getElementById('startCameraBtn').disabled = false;
                if (latestFrameTimeout) clearTimeout(latestFrameTimeout);
                emotionLabel.textContent = '--';
            }
        };
        function scheduleFrameSend() {
            if (!streaming) return;
            if (!sendingFrame) {
                sendFrameToServer();
            }
            latestFrameTimeout = setTimeout(() => requestAnimationFrame(scheduleFrameSend), 300);
        }
        function sendFrameToServer() {
            if (!streaming || sendingFrame) return;
            sendingFrame = true;
            
            // Create a temporary canvas to capture the video frame
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth || 640;
            tempCanvas.height = video.videoHeight || 480;
            const ctx = tempCanvas.getContext('2d');
            ctx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
            
            tempCanvas.toBlob(function(blob) {
                const formData = new FormData();
                formData.append('frame', blob, 'frame.jpg');
                addDebugLog('Sending frame to server...');
                fetch('/process_frame', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    addDebugLog('Received response from server.');
                    return response.json();
                })
                .then(data => {
                    const ctxProcessed = processedFrame.getContext('2d');
                    let img = new window.Image();
                    img.onload = function() {
                        ctxProcessed.clearRect(0, 0, processedFrame.width, processedFrame.height);
                        ctxProcessed.drawImage(img, 0, 0, processedFrame.width, processedFrame.height);
                    };
                    img.src = 'data:image/jpeg;base64,' + data.image;
                    emotionLabel.textContent = data.emotion;
                    resultContainer.style.display = 'block';
                    analysisPlaceholder.style.display = 'none';
                    addDebugLog('Emotion: ' + data.emotion + '\nFrame processed and displayed.' + (data.debug ? ('\n' + data.debug) : ''));

                    // --- Live chart and session history update ---
                    const now = new Date();
                    const timestamp = now.toLocaleTimeString();
                    addEmotionToChart(data.emotion, timestamp);
                    // Add to session history table (if emotion is not '--')
                    if (data.emotion && data.emotion !== '--') {
                        const tableBody = document.getElementById('session-history-body');
                        const newRow = document.createElement('tr');
                        const dateCell = document.createElement('td');
                        const emotionCell = document.createElement('td');
                        dateCell.textContent = now.toLocaleString();
                        emotionCell.innerHTML = `<span class="badge bg-primary">${data.emotion}</span>`;
                        newRow.appendChild(dateCell);
                        newRow.appendChild(emotionCell);
                        tableBody.insertBefore(newRow, tableBody.firstChild);
                        while (tableBody.children.length > 10) {
                            tableBody.removeChild(tableBody.lastChild);
                        }
                    }
                    // --- End live update ---
                })
                .catch(err => {
                    addDebugLog('Error: ' + err.message);
                })
                .finally(() => {
                    sendingFrame = false;
                });
            }, 'image/jpeg');
        }

        document.getElementById('captureEmotionBtn').onclick = function() {
            const emotion = emotionLabel.textContent;
            if (emotion && emotion !== '--') {
                const now = new Date();
                const timestamp = now.toLocaleTimeString();
                
                // Add to session history table
                const tableBody = document.getElementById('session-history-body');
                const newRow = document.createElement('tr');
                const dateCell = document.createElement('td');
                const emotionCell = document.createElement('td');

                dateCell.textContent = now.toLocaleString();
                emotionCell.innerHTML = `<span class="badge bg-primary">${emotion}</span>`;

                newRow.appendChild(dateCell);
                newRow.appendChild(emotionCell);
                tableBody.insertBefore(newRow, tableBody.firstChild);

                // Remove rows if more than 10 are visible
                while (tableBody.children.length > 10) {
                    tableBody.removeChild(tableBody.lastChild);
                }
                
                // Add to live chart immediately
                addEmotionToChart(emotion, timestamp);
                
                // Add visual feedback
                const btn = document.getElementById('captureEmotionBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Captured!';
                btn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 1500);

                // Send captured emotion to the backend
                fetch('/capture_emotion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ emotion })
                })
                .then(async response => {
                    let data;
                    let text = null;
                    try {
                        text = await response.text();
                        data = JSON.parse(text);
                    } catch (e) {
                        addDatabaseLog(`Backend returned non-JSON: ${text ? text.substring(0, 100) : e}`);
                        addDebugLog(`Backend returned non-JSON: ${text ? text.substring(0, 100) : e}`);
                        return;
                    }
                    if (data.success) {
                        addDebugLog(`Captured emotion logged: ${emotion}`);
                        addDatabaseLog(`Captured emotion logged: ${emotion}`);
                    } else {
                        let scaryMsg =
                            '🚫 ERROR: Unable to log emotion. DEMO MODE does not allow saving logs. Please LOG IN or REGISTER to save your emotion history! (Demo mode data will be lost)';
                        addDebugLog(scaryMsg);
                        addDatabaseLog(scaryMsg);
                    }
                })
                .catch(err => {
                    addDebugLog(`Error sending emotion to backend: ${err.message}`);
                    addDatabaseLog(`Error sending emotion to backend: ${err.message}`);
                });
            } else {
                addDebugLog('No emotion detected to capture.');
                
                // Show error feedback
                const btn = document.getElementById('captureEmotionBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>No Emotion Detected';
                btn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }
        };
    </script>

</body>
</html>